<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fruit Order Prototype</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@500;700&family=Nanum+Pen+Script&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: only light;
        --bg: #fdeee6;
        --panel: #fff6ef;
        --panel-2: #ffe9d7;
        --line: #6b4b3e;
        --accent: #f6b26b;
        --accent-2: #f2a1b8;
        --accent-3: #9cd3b3;
        --shadow: rgba(107, 75, 62, 0.2);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: var(--bg);
        font-family: "Malgun Gothic", "Apple SD Gothic Neo", system-ui, sans-serif;
        color: var(--line);
      }

      button {
        font-family: inherit;
      }

      .app {
        min-height: 100vh;
        padding: 24px 28px 32px;
        max-width: 1100px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
      }

      .top-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .pill-button {
        border: 4px solid var(--line);
        background: #fff3e8;
        border-radius: 999px;
        padding: 10px 18px;
        font-weight: 700;
        box-shadow: 0 4px 0 var(--line);
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      .pill-button:hover {
        transform: translateY(-2px);
      }

      .pill-button:active {
        transform: translateY(2px);
        box-shadow: 0 2px 0 var(--line);
      }

      .pill-button.home {
        width: 44px;
        height: 44px;
        padding: 0;
        background: #ffe1d0;
        color: #9b3b2c;
        position: relative;
        display: grid;
        place-items: center;
      }

      .pill-button.upgrade {
        background: #ffe1d0;
        font-family: "Baloo 2", "Nanum Pen Script", "Trebuchet MS", sans-serif;
      }

      .home-icon {
        position: relative;
        width: 16px;
        height: 12px;
        display: block;
        background: #9b3b2c;
        border-radius: 2px;
        transform: translateY(2px);
      }

      .home-icon::before {
        content: "";
        position: absolute;
        left: 50%;
        top: -9px;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-bottom: 10px solid #9b3b2c;
      }

      .home-icon::after {
        content: "";
        position: absolute;
        left: 50%;
        bottom: 2px;
        transform: translateX(-50%);
        width: 5px;
        height: 6px;
        background: #ffe1d0;
        border-radius: 1px;
      }

      .top-right {
        display: grid;
        gap: 10px;
      }

      .home-screen {
        display: none;
        padding: 16px 0 28px;
      }

      .home-screen.is-visible {
        display: block;
      }

      .game-screen.is-hidden {
        display: none;
      }

      .home-title {
        text-align: center;
        font-size: 40px;
        font-weight: 800;
        letter-spacing: 1px;
        margin: 12px 0 18px;
        font-family: "Baloo 2", "Nanum Pen Script", "Trebuchet MS", sans-serif;
      }

      .home-content {
        display: grid;
        grid-template-columns: 1fr 170px;
        gap: 18px;
        align-items: start;
      }

      .home-panel {
        background: var(--panel);
        border: 4px solid var(--line);
        border-radius: 20px;
        padding: 16px;
        box-shadow: 0 4px 0 var(--line);
      }

      .home-customers {
        display: flex;
        gap: 16px;
        justify-content: space-between;
        align-items: flex-end;
        flex-wrap: nowrap;
        overflow-x: auto;
        padding-bottom: 6px;
      }

      .home-customer {
        position: relative;
        display: grid;
        gap: 10px;
        justify-items: center;
        padding: 6px 4px;
        min-width: 100px;
      }

      .home-customer-image {
        width: 84px;
        height: 92px;
        object-fit: contain;
      }

      .home-bubble {
        background: #fff;
        border: 3px solid var(--line);
        border-radius: 16px;
        padding: 6px 10px;
        position: relative;
        min-height: 34px;
        display: grid;
        align-items: center;
        box-shadow: 0 3px 0 var(--line);
      }

      .home-bubble::after {
        content: "";
        position: absolute;
        left: 16px;
        bottom: -10px;
        width: 16px;
        height: 16px;
        background: #fff;
        border-left: 3px solid var(--line);
        border-bottom: 3px solid var(--line);
        transform: rotate(-45deg);
      }

      .home-bubble-items {
        display: flex;
        gap: 6px;
      }

      .home-bubble .home-fruit-chip {
        transform: scale(0.88);
        transform-origin: center;
      }

      .home-bubble .plate-fruit {
        width: 22px;
        height: 22px;
        margin: 0;
      }

      .home-bubble .plate-fruit.blueberry {
        width: 22px;
        height: 22px;
        box-shadow: inset -1px -2px 0 rgba(0, 0, 0, 0.12);
      }

      .home-bubble .plate-fruit.pineapple {
        width: 20px;
        height: 26px;
      }

      .home-bubble .plate-fruit.melon {
        width: 20px;
        height: 20px;
        margin-top: 2px;
      }

      .home-stages {
        display: grid;
        gap: 12px;
      }

      .stage-button {
        border: 4px solid var(--line);
        border-radius: 16px;
        padding: 12px 10px;
        font-weight: 800;
        background: #fff3e8;
        box-shadow: 0 4px 0 var(--line);
        cursor: pointer;
        text-align: center;
        font-family: "Baloo 2", "Nanum Pen Script", "Trebuchet MS", sans-serif;
      }

      .stage-button:active {
        transform: translateY(2px);
        box-shadow: 0 2px 0 var(--line);
      }

      .resource {
        background: var(--panel);
        border: 4px solid var(--line);
        border-radius: 14px;
        padding: 8px 12px;
        width: 120px;
        display: flex;
        justify-content: space-between;
        box-shadow: 0 4px 0 var(--line);
        font-size: 14px;
      }

      .main-grid {
        display: grid;
        grid-template-columns: 1fr 180px;
        gap: 18px;
        align-items: stretch;
      }

      .side-panel {
        background: var(--panel);
        border: 4px solid var(--line);
        border-radius: 20px;
        padding: 14px;
        box-shadow: 0 6px 0 var(--line);
        display: grid;
        gap: 16px;
        min-height: 520px;
      }

      .side-panel.right {
        position: relative;
      }

      .side-panel.right h3 {
        display: none;
      }

      .timer-panel {
        background: #fff1e3;
        border: 3px solid var(--line);
        border-radius: 16px;
        padding: 14px;
        display: grid;
        gap: 10px;
        text-align: center;
        font-family: system-ui, sans-serif;
      }

      .timer-title {
        font-weight: 700;
        font-size: 14px;
      }

      .timer-alarm {
        margin-top: -12px;
        display: grid;
        place-items: center;
      }

      .alarm-body {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        border: 4px solid var(--line);
        background: #fff8f1;
        position: relative;
        box-shadow: 0 4px 0 var(--line);
      }

      .alarm-bell {
        position: absolute;
        width: 16px;
        height: 12px;
        background: #ffd7b5;
        border: 3px solid var(--line);
        border-radius: 50% 50% 40% 40%;
        top: -10px;
      }

      .alarm-bell.left {
        left: -6px;
        transform: rotate(-18deg);
      }

      .alarm-bell.right {
        right: -6px;
        transform: rotate(18deg);
      }

      .alarm-leg {
        position: absolute;
        width: 10px;
        height: 5px;
        background: var(--line);
        border-radius: 6px;
        bottom: -5px;
      }

      .alarm-leg.left {
        left: 8px;
        transform: rotate(18deg);
      }

      .alarm-leg.right {
        right: 8px;
        transform: rotate(-18deg);
      }

      .alarm-hand {
        position: absolute;
        width: 4px;
        height: 12px;
        background: var(--line);
        border-radius: 4px;
        top: 12px;
        left: 50%;
        transform-origin: bottom;
      }

      .alarm-hand.hour {
        height: 9px;
        transform: translateX(-50%) rotate(-30deg);
      }

      .alarm-hand.minute {
        transform: translateX(-50%) rotate(60deg);
      }

      .alarm-tick {
        position: absolute;
        width: 4px;
        height: 6px;
        background: var(--line);
        border-radius: 2px;
      }

      .alarm-tick.t1 { top: 4px; left: 50%; transform: translateX(-50%); }
      .alarm-tick.t2 { right: 6px; top: 50%; transform: translateY(-50%) rotate(90deg); }
      .alarm-tick.t3 { bottom: 4px; left: 50%; transform: translateX(-50%); }
      .alarm-tick.t4 { left: 6px; top: 50%; transform: translateY(-50%) rotate(90deg); }

      .timer-bar {
        height: 12px;
        border-radius: 999px;
        border: 2px solid var(--line);
        background: #ffe5d0;
        overflow: hidden;
      }

      .timer-fill {
        height: 100%;
        width: 100%;
        background: #9cd3b3;
        transition: width 0.3s ease;
      }

      .timer-text {
        font-size: 16px;
        font-weight: 700;
        margin-top: -6px;
      }

      .timer-actions {
        display: grid;
        grid-template-columns: 1fr;
        gap: 6px;
      }

      .timer-button {
        border: 3px solid var(--line);
        border-radius: 12px;
        padding: 5px 8px;
        background: #ffe1d0;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 3px 0 var(--line);
        font-size: 11px;
      }

      .timer-button:active {
        transform: translateY(2px);
        box-shadow: 0 1px 0 var(--line);
      }

      .clock-timer {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .clock-face {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        border: 4px solid var(--line);
        background: #fff8f1;
        position: relative;
        overflow: visible;
        box-shadow: 0 4px 0 var(--line);
      }

      .clock-face::before {
        content: "";
        position: absolute;
        inset: -6px;
        border: 2px solid var(--line);
        border-radius: 50%;
        transform: scale(0.85);
      }

      .clock-top-button {
        position: absolute;
        top: -8px;
        left: 50%;
        width: 20px;
        height: 8px;
        background: var(--line);
        border-radius: 6px;
        transform: translateX(-50%);
        z-index: 3;
      }

      .clock-handle {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 3px;
        height: 12px;
        background: var(--line);
        border-radius: 999px;
        transform: translate(-50%, -100%) rotate(20deg);
        transform-origin: bottom;
        z-index: 2;
      }

      .clock-fill {
        position: absolute;
        inset: 4px;
        border-radius: 50%;
        background: conic-gradient(#4aa6d6 360deg, transparent 0deg);
        transition: background 0.2s linear;
      }

      .clock-center {
        position: absolute;
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: var(--line);
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 3;
      }

      .clock-toggle {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #ffe38a, #f2a833);
        border: 4px solid #a44a2b;
        box-shadow: 0 4px 0 #a44a2b;
        display: grid;
        place-items: center;
        cursor: pointer;
      }

      .clock-toggle:active {
        transform: translateY(2px);
        box-shadow: 0 2px 0 #a44a2b;
      }

      .clock-toggle .icon-play,
      .clock-toggle .icon-pause {
        position: relative;
        display: block;
      }

      .clock-toggle .icon-play {
        width: 0;
        height: 0;
        border-top: 7px solid transparent;
        border-bottom: 7px solid transparent;
        border-left: 12px solid #9b3b2c;
        margin-left: 2px;
      }

      .clock-toggle .icon-pause {
        width: 14px;
        height: 16px;
        display: grid;
        grid-template-columns: repeat(2, 4px);
        gap: 3px;
      }

      .clock-toggle .icon-pause::before,
      .clock-toggle .icon-pause::after {
        content: "";
        width: 4px;
        height: 16px;
        background: #9b3b2c;
        border-radius: 2px;
        display: block;
      }

      .clock-toggle[data-state="playing"] .icon-play {
        display: none;
      }

      .clock-toggle[data-state="paused"] .icon-pause {
        display: none;
      }

      .tool-list {
        display: grid;
        gap: 12px;
      }

      .tool-item {
        background: #fff1e3;
        border: 3px solid var(--line);
        border-radius: 14px;
        padding: 10px 12px;
        display: flex;
        justify-content: space-between;
        font-weight: 700;
        box-shadow: 0 3px 0 var(--line);
      }

      .container-row {
        display: grid;
        gap: 10px;
      }

      .small-button {
        border: 3px solid var(--line);
        border-radius: 14px;
        background: #fff8f1;
        padding: 10px 12px;
        display: flex;
        justify-content: space-between;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 3px 0 var(--line);
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      .small-button:hover {
        transform: translateY(-2px);
      }

      .small-button:active {
        transform: translateY(2px);
        box-shadow: 0 1px 0 var(--line);
      }

      .topping-grid {
        display: grid;
        place-items: center;
        min-height: 220px;
        position: relative;
        margin-top: 70px;
      }

      .plate-illustration {
        width: 140px;
        height: 96px;
        border-radius: 50%;
        background: radial-gradient(circle at 50% 38%, #ffffff 40%, #e6e6e6 100%);
        border: 4px solid #bdbdbd;
        position: relative;
        box-shadow: inset 0 -10px 0 rgba(0, 0, 0, 0.08);
        z-index: 1;
      }

      .plate-illustration::before {
        content: "";
        position: absolute;
        inset: 16px 22px 20px;
        border-radius: 50%;
        border: 3px solid #d5d5d5;
        background: radial-gradient(circle at 50% 40%, #ffffff 35%, #f3f3f3 100%);
      }

      .plate-illustration::after {
        content: "";
        position: absolute;
        left: 10%;
        right: 10%;
        bottom: -8px;
        height: 16px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.12);
        filter: blur(2px);
      }

      .serve-button {
        border: 4px solid var(--line);
        background: #ffd7b5;
        border-radius: 16px;
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 700;
        font-family: "Malgun Gothic", "Apple SD Gothic Neo", system-ui, sans-serif;
        cursor: pointer;
        box-shadow: 0 4px 0 var(--line);
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        margin-top: 6px;
      }

      .clear-button {
        border: 4px solid var(--line);
        background: #ffd7b5;
        border-radius: 16px;
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 700;
        font-family: "Malgun Gothic", "Apple SD Gothic Neo", system-ui, sans-serif;
        cursor: pointer;
        box-shadow: 0 4px 0 var(--line);
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        margin-top: 6px;
      }

      .clear-button:hover {
        transform: translateY(-2px);
      }

      .clear-button:active {
        transform: translateY(2px);
        box-shadow: 0 2px 0 var(--line);
      }

      .serve-button:hover {
        transform: translateY(-2px);
      }

      .serve-button:active {
        transform: translateY(2px);
        box-shadow: 0 2px 0 var(--line);
      }

      .serve-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: 0 4px 0 var(--line);
      }

      .result-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 99;
      }

      .result-overlay.active {
        display: flex;
      }

      .result-card {
        background: #fff8f1;
        border: 4px solid var(--line);
        border-radius: 18px;
        padding: 20px 24px;
        text-align: center;
        box-shadow: 0 8px 0 var(--line);
        min-width: 240px;
        font-family: system-ui, sans-serif;
      }

      .result-card.stage {
        background: #fff1e3;
      }

      .result-card p {
        margin: 0 0 12px;
        font-weight: 700;
      }

      .result-card button {
        border: 3px solid var(--line);
        border-radius: 12px;
        padding: 8px 12px;
        background: #ffe1d0;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 3px 0 var(--line);
      }

      .plate-drop {
        position: relative;
        display: grid;
        place-items: center;
        gap: 8px;
        padding-top: 64px;
      }

      .plate-items {
        position: absolute;
        top: 70px;
        width: 120px;
        height: 70px;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-auto-rows: 24px;
        justify-items: center;
        align-content: start;
        row-gap: 4px;
        column-gap: 1px;
        z-index: 2;
      }

      .plate-items span {
        filter: drop-shadow(0 2px 0 rgba(0, 0, 0, 0.15));
      }

      .plate-chip {
        position: relative;
        display: inline-grid;
        place-items: center;
      }

      .plate-remove {
        position: absolute;
        top: -6px;
        right: -6px;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid var(--line);
        background: #fff1e3;
        color: var(--line);
        font-size: 10px;
        line-height: 1;
        display: grid;
        place-items: center;
        opacity: 0;
        cursor: pointer;
        transition: opacity 0.15s ease;
      }

      .plate-chip:hover .plate-remove {
        opacity: 1;
      }

      .note-stickers {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: grid;
        grid-template-columns: repeat(3, auto);
        gap: 6px;
        z-index: 5;
        pointer-events: none;
        justify-items: center;
      }

      .note-chip {
        background: #fff1e3;
        border: 2px solid var(--line);
        border-radius: 8px;
        padding: 4px 6px;
        font-size: 10px;
        font-family: system-ui, sans-serif;
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
        width: 48px;
        height: 68px;
        justify-content: center;
        font-weight: 700;
      }

      .note-chip span {
        white-space: nowrap;
      }

      .note-chip .note {
        width: 16px;
        height: 24px;
      }

      .note-chip .head {
        width: 10px;
        height: 6px;
      }

      .note-chip .stem {
        height: 16px;
      }

      .plate-fruit {
        position: relative;
        width: 24px;
        height: 24px;
        border: 2px solid var(--line);
        border-radius: 50%;
        box-shadow: inset -2px -3px 0 rgba(0, 0, 0, 0.08);
        background: radial-gradient(circle at 30% 30%, var(--fruit-light), var(--fruit-dark));
      }

      .plate-fruit.orange {
        width: 22px;
        height: 22px;
        background:
          radial-gradient(circle at 28% 30%, rgba(255, 200, 150, 0.7) 0 0.7px, transparent 1.6px),
          radial-gradient(circle at 58% 24%, rgba(255, 200, 150, 0.7) 0 0.7px, transparent 1.6px),
          radial-gradient(circle at 70% 58%, rgba(255, 200, 150, 0.65) 0 0.7px, transparent 1.6px),
          radial-gradient(circle at 34% 70%, rgba(255, 200, 150, 0.6) 0 0.7px, transparent 1.6px),
          radial-gradient(circle at 52% 82%, rgba(255, 200, 150, 0.6) 0 0.7px, transparent 1.6px),
          radial-gradient(circle at 30% 30%, var(--fruit-light), var(--fruit-dark));
      }

      .plate-fruit.leaf::after {
        content: "";
        position: absolute;
        top: -4px;
        right: 0;
        width: 8px;
        height: 6px;
        background: var(--leaf, #6abf69);
        border-radius: 6px 10px 6px 10px;
        border: 2px solid var(--line);
        transform: rotate(-12deg);
      }

      .plate-fruit.orange::after {
        width: 10px;
        height: 10px;
        top: -6px;
        left: 50%;
        right: auto;
        border-radius: 0;
        clip-path: polygon(
          50% 0%,
          61% 36%,
          98% 35%,
          68% 58%,
          79% 92%,
          50% 72%,
          21% 92%,
          32% 58%,
          2% 35%,
          39% 36%
        );
        transform: translateX(-50%);
      }

      .plate-fruit.pineapple::after {
        width: 16px;
        height: 16px;
        top: -10px;
        left: 50%;
        right: auto;
        border-radius: 0;
        clip-path: polygon(
          50% 0%,
          65% 32%,
          100% 40%,
          70% 55%,
          78% 90%,
          50% 68%,
          22% 90%,
          30% 55%,
          0% 40%,
          35% 32%
        );
        transform: translateX(-50%) rotate(-10deg);
      }

      .plate-fruit.peach {
        width: 28px;
        height: 24px;
        border-radius: 50%;
        clip-path: ellipse(55% 48% at 50% 52%);
      }

      .plate-fruit.peach::before {
        content: "";
        position: absolute;
        top: -6px;
        left: 50%;
        width: 3px;
        height: 8px;
        background: #6b4b3e;
        border-radius: 999px;
        transform: translateX(-50%) rotate(-12deg);
      }

      .plate-fruit.peach .peach-line {
        position: absolute;
        top: 4px;
        left: 50%;
        width: 10px;
        height: 18px;
        border-left: 2px solid rgba(0, 0, 0, 0.2);
        border-radius: 999px;
        transform: translateX(-50%);
      }

      .plate-fruit.melon {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        background:
          repeating-linear-gradient(
            45deg,
            rgba(255, 255, 255, 0.35) 0 2px,
            transparent 2px 6px
          ),
          repeating-linear-gradient(
            -45deg,
            rgba(255, 255, 255, 0.35) 0 2px,
            transparent 2px 6px
          ),
          radial-gradient(circle at 30% 30%, var(--fruit-light), var(--fruit-dark));
      }

      .plate-fruit.melon::before {
        content: "";
        position: absolute;
        top: -8px;
        left: 50%;
        width: 10px;
        height: 4px;
        background: #8b8f57;
        border-radius: 999px;
        transform: translateX(-50%);
        border: 2px solid var(--line);
      }

      .plate-fruit.pineapple {
        width: 24px;
        height: 34px;
        border-radius: 45% 45% 60% 60%;
        background:
          repeating-linear-gradient(
            45deg,
            rgba(255, 255, 255, 0.35) 0 3px,
            transparent 3px 8px
          ),
          repeating-linear-gradient(
            -45deg,
            rgba(255, 255, 255, 0.35) 0 3px,
            transparent 3px 8px
          ),
          radial-gradient(circle at 30% 30%, var(--fruit-light), var(--fruit-dark));
      }

      .plate-fruit.apple {
        border-radius: 55% 55% 45% 45% / 58% 58% 45% 45%;
      }

      .plate-fruit.apple::before {
        content: "";
        position: absolute;
        top: -6px;
        left: 50%;
        width: 3px;
        height: 8px;
        background: #6b4b3e;
        border-radius: 999px;
        transform: translateX(-50%) rotate(-12deg);
      }

      .plate-fruit.blueberry {
        width: 16px;
        height: 16px;
        box-shadow: inset -1px -2px 0 rgba(0, 0, 0, 0.12);
      }

      .plate-fruit.blueberry::after {
        content: "";
        position: absolute;
        top: 4px;
        left: 50%;
        width: 6px;
        height: 3px;
        background: rgba(0, 0, 0, 0.25);
        border-radius: 0 0 999px 999px;
        transform: translateX(-50%);
      }

      .workbench {
        background: var(--panel-2);
        border: 4px solid var(--line);
        border-radius: 24px;
        padding: 70px 18px 18px;
        display: grid;
        gap: 18px;
        box-shadow: 0 8px 0 var(--line);
        position: relative;
      }

      .workbench .clock-timer {
        position: absolute;
        top: 12px;
        left: 12px;
      }

      .stage4-note {
        position: absolute;
        top: 12px;
        right: 12px;
        max-width: 240px;
        background: #fff8f1;
        border: 3px solid var(--line);
        border-radius: 14px;
        padding: 8px 10px;
        font-size: 13px;
        font-weight: 700;
        line-height: 1.4;
        box-shadow: 0 3px 0 var(--line);
        display: none;
      }

      .stage4-note.is-visible {
        display: block;
      }

      .customer-panel {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 18px;
        align-items: center;
      }

      .customer {
        display: grid;
        place-items: center;
        position: relative;
        padding: 10px;
      }

      .customer-image {
        width: 140px;
        height: auto;
        display: block;
      }

      .bear {
        display: none;
      }

      .bear .head {
        width: 120px;
        height: 110px;
        background: #d69a62;
        border: 4px solid var(--line);
        border-radius: 50% 50% 46% 46%;
        position: relative;
      }

      .bear .ear {
        position: absolute;
        width: 34px;
        height: 34px;
        background: #d69a62;
        border: 4px solid var(--line);
        border-radius: 50%;
        top: -10px;
      }

      .bear .ear.left {
        left: 8px;
      }

      .bear .ear.right {
        right: 8px;
      }

      .bear .muzzle {
        display: none;
      }

      .bear .eye {
        position: absolute;
        top: 40px;
        width: 8px;
        height: 8px;
        background: #3e2b22;
        border-radius: 50%;
      }

      .bear .eye.left {
        left: 36px;
      }

      .bear .eye.right {
        right: 36px;
      }

      .bear .nose {
        position: absolute;
        top: 52px;
        left: 50%;
        width: 10px;
        height: 8px;
        background: #3e2b22;
        border-radius: 50%;
        transform: translateX(-50%);
      }

      .bear .mouth {
        position: absolute;
        top: 66px;
        left: 50%;
        width: 20px;
        height: 10px;
        transform: translateX(-50%);
      }

      .bear .mouth::before,
      .bear .mouth::after {
        content: "";
        position: absolute;
        top: 0;
        width: 10px;
        height: 8px;
        border-bottom: 3px solid #3e2b22;
        border-radius: 0 0 12px 12px;
      }

      .bear .mouth::before {
        left: 0;
        transform: rotate(8deg);
      }

      .bear .mouth::after {
        right: 0;
        transform: rotate(-8deg);
      }

      .bear .shirt {
        display: none;
      }

      .order-card {
        background: #ffffff;
        border: 4px solid var(--line);
        border-radius: 16px;
        padding: 8px 10px;
        box-shadow: 0 4px 0 var(--line);
        position: relative;
        max-width: 140px;
      }

      .order-card::after {
        content: "";
        position: absolute;
        left: -12px;
        top: 50%;
        width: 14px;
        height: 14px;
        background: #ffffff;
        border-left: 4px solid var(--line);
        border-bottom: 4px solid var(--line);
        transform: translateY(-50%) rotate(45deg);
      }

      .order-items {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .order-item {
        background: #fff1e3;
        border: 3px solid var(--line);
        border-radius: 12px;
        padding: 6px 10px;
        display: flex;
        gap: 6px;
        font-weight: 700;
        align-items: center;
      }

      .order-item .plate-fruit {
        width: 22px;
        height: 22px;
      }

      .order-item .plate-fruit.blueberry,
      .order-item .plate-fruit.pineapple,
      .order-item .plate-fruit.peach {
        width: 22px;
        height: 22px;
      }

      .order-item .plate-fruit.melon {
        margin-top: 2px;
      }

      .order-qty {
        font-weight: 800;
      }

      .fruit-bins {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
      }

      .fruit-slot {
        background: transparent;
        border: none;
        border-radius: 0;
        padding: 6px 2px 2px;
        display: grid;
        place-items: end center;
        gap: 6px;
        position: relative;
        cursor: default;
        box-shadow: none;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      .fruit-slot:hover {
        transform: translateY(-2px);
      }

      .fruit-slot:active {
        transform: translateY(2px);
        box-shadow: 0 3px 0 var(--line);
      }

      .basket {
        width: 100%;
        height: 86px;
        border: 4px solid var(--line);
        border-radius: 12px;
        background: #e2b98f;
        position: relative;
        overflow: hidden;
        z-index: 1;
        box-shadow: 0 6px 0 rgba(0, 0, 0, 0.08);
      }

      .basket::before {
        content: none;
      }

      .basket::after {
        content: none;
      }

      .crate-plank {
        display: none;
      }

      .crate-plank.top {
        top: 30px;
      }

      .crate-plank.mid {
        top: 48px;
      }

      .crate-plank.bottom {
        top: 66px;
      }

      .crate-sticker {
        position: absolute;
        right: 6px;
        top: 30px;
        transform: none;
        background: #fff8f1;
        border: 3px solid var(--line);
        border-radius: 10px;
        padding: 4px 6px;
        text-align: center;
        font-weight: 700;
        font-size: 11px;
        min-width: 56px;
        box-shadow: 0 2px 0 var(--line);
        line-height: 1.2;
        font-family: system-ui, sans-serif;
      }

      .crate-sticker span {
        display: block;
        font-size: 13px;
      }

      .fruit-label {
        position: absolute;
        left: 2px;
        top: -14px;
        background: #fff1e3;
        border: 2px solid var(--line);
        border-radius: 8px;
        padding: 3px 7px;
        font-size: 11px;
        font-weight: 700;
        box-shadow: 0 2px 0 var(--line);
        font-family: system-ui, sans-serif;
        z-index: 3;
      }

      .note {
        position: relative;
        display: inline-block;
        width: 16px;
        height: 22px;
        margin: 0 auto 1px;
      }

      .note .head {
        position: absolute;
        bottom: 2px;
        left: 2px;
        width: 10px;
        height: 6px;
        border-radius: 50%;
        background: var(--line);
        transform: rotate(-12deg);
      }

      .note.hollow .head {
        background: transparent;
        border: 2px solid var(--line);
      }

      .note .stem {
        position: absolute;
        right: 3px;
        bottom: 6px;
        width: 2px;
        height: 14px;
        background: var(--line);
      }

      .note .flag {
        position: absolute;
        right: -1px;
        width: 6px;
        height: 5px;
        border-top: 2px solid var(--line);
        border-right: 2px solid var(--line);
        border-radius: 0 8px 0 0;
      }

      .note .flag.flag1 {
        top: 4px;
      }

      .note .flag.flag2 {
        top: 10px;
      }

      .note.whole .stem {
        display: none;
      }

      .note.whole .head {
        width: 12px;
        height: 7px;
        left: 1px;
        background: transparent;
        border: 2px solid var(--line);
      }

      .note .dot {
        position: absolute;
        bottom: 6px;
        left: 14px;
        width: 3px;
        height: 3px;
        background: var(--line);
        border-radius: 50%;
      }

      .fruit-cluster {
        position: absolute;
        top: -8px;
        left: 14px;
        width: 150px;
        height: 88px;
        transform: none;
        pointer-events: none;
        z-index: 2;
      }

      .fruit-piece {
        position: absolute;
        width: 34px;
        height: 34px;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, var(--fruit-light), var(--fruit-dark));
        border: 3px solid var(--line);
        box-shadow: inset -4px -6px 0 rgba(0, 0, 0, 0.08);
      }

      .fruit-piece.leaf::after {
        content: "";
        position: absolute;
        top: -6px;
        right: 2px;
        width: 12px;
        height: 8px;
        background: var(--leaf, #6abf69);
        border-radius: 8px 12px 8px 12px;
        border: 2px solid var(--line);
        transform: rotate(-12deg);
      }

      .fruit-slot.orange .fruit-piece.leaf::after {
        width: 14px;
        height: 14px;
        top: -8px;
        left: 50%;
        right: auto;
        border-radius: 0;
        clip-path: polygon(
          50% 0%,
          61% 36%,
          98% 35%,
          68% 58%,
          79% 92%,
          50% 72%,
          21% 92%,
          32% 58%,
          2% 35%,
          39% 36%
        );
        transform: translateX(-50%);
      }

      .p1 { left: 8px; top: 26px; }
      .p2 { left: 38px; top: 10px; }
      .p3 { left: 74px; top: 18px; }
      .p4 { left: 20px; top: 44px; }
      .p5 { left: 56px; top: 40px; }
      .p6 { left: 94px; top: 34px; }
      .p7 { left: 46px; top: 58px; }
      .p8 { left: 12px; top: 12px; }
      .p9 { left: 62px; top: 6px; }
      .p10 { left: 88px; top: 56px; }
      .p11 { left: 30px; top: 62px; }
      .p12 { left: 78px; top: 66px; }
      .p13 { left: 14px; top: 34px; }
      .p14 { left: 52px; top: 24px; }
      .p15 { left: 68px; top: 42px; }
      .p16 { left: 40px; top: 48px; }
      .p17 { left: 22px; top: 18px; }
      .p18 { left: 84px; top: 20px; }
      .p19 { left: 96px; top: 44px; }
      .p20 { left: 50px; top: 70px; }

      .fruit-slot.orange .fruit-piece {
        width: 32px;
        height: 32px;
        background:
          radial-gradient(circle at 28% 30%, rgba(255, 200, 150, 0.7) 0 0.9px, transparent 1.9px),
          radial-gradient(circle at 58% 24%, rgba(255, 200, 150, 0.7) 0 0.9px, transparent 1.9px),
          radial-gradient(circle at 70% 58%, rgba(255, 200, 150, 0.65) 0 0.9px, transparent 1.9px),
          radial-gradient(circle at 34% 70%, rgba(255, 200, 150, 0.6) 0 0.9px, transparent 1.9px),
          radial-gradient(circle at 52% 82%, rgba(255, 200, 150, 0.6) 0 0.9px, transparent 1.9px),
          radial-gradient(circle at 30% 30%, var(--fruit-light), var(--fruit-dark));
      }

      .fruit-slot.apple .fruit-piece {
        width: 38px;
        height: 38px;
        border-radius: 55% 55% 45% 45% / 58% 58% 45% 45%;
        background: radial-gradient(circle at 30% 30%, var(--fruit-light), var(--fruit-dark));
      }

      .fruit-slot.apple .fruit-piece::before {
        content: "";
        position: absolute;
        top: -8px;
        left: 50%;
        width: 4px;
        height: 14px;
        background: #6b4b3e;
        border-radius: 999px;
        transform: translateX(-50%) rotate(-12deg);
        box-shadow: 0 0 0 1px var(--line);
      }

      .fruit-slot.apple .fruit-piece::after {
        content: "";
        position: absolute;
        top: 6px;
        left: 50%;
        width: 10px;
        height: 6px;
        border-bottom: 3px solid var(--line);
        border-radius: 0 0 999px 999px;
        transform: translateX(-50%);
        background: transparent;
      }


      .fruit-slot.apple .fruit-piece.leaf::after {
        width: 16px;
        height: 12px;
        top: -8px;
        right: -2px;
        background: #77c36f;
        border-radius: 6px 14px 6px 14px;
        border: 2px solid var(--line);
        transform: rotate(-18deg);
      }

      .fruit-slot.blueberry .fruit-piece {
        width: 18px;
        height: 18px;
        box-shadow: inset -1px -2px 0 rgba(0, 0, 0, 0.12);
      }

      .fruit-slot.blueberry .fruit-cluster {
        transform: translateX(-6px) scale(1.08);
      }

      .fruit-slot.blueberry .fruit-piece::after {
        content: "";
        position: absolute;
        top: 5px;
        left: 50%;
        width: 7px;
        height: 3px;
        background: rgba(0, 0, 0, 0.22);
        border-radius: 0 0 999px 999px;
        transform: translateX(-50%);
      }

      .fruit-slot.peach .fruit-piece {
        width: 40px;
        height: 34px;
        border-radius: 50%;
        clip-path: ellipse(55% 48% at 50% 52%);
      }

      .fruit-slot.peach .fruit-piece::before {
        content: "";
        position: absolute;
        top: -8px;
        left: 50%;
        width: 4px;
        height: 10px;
        background: #6b4b3e;
        border-radius: 999px;
        transform: translateX(-50%) rotate(-12deg);
      }

      .fruit-slot.peach .fruit-piece .peach-line {
        position: absolute;
        top: 6px;
        left: 50%;
        width: 12px;
        height: 22px;
        border-left: 2px solid rgba(0, 0, 0, 0.2);
        border-radius: 999px;
        transform: translateX(-50%);
      }

      .fruit-slot.melon .fruit-piece {
        width: 52px;
        height: 52px;
        border-radius: 50%;
        background:
          repeating-linear-gradient(
            45deg,
            rgba(255, 255, 255, 0.35) 0 3px,
            transparent 3px 8px
          ),
          repeating-linear-gradient(
            -45deg,
            rgba(255, 255, 255, 0.35) 0 3px,
            transparent 3px 8px
          ),
          radial-gradient(circle at 30% 30%, var(--fruit-light), var(--fruit-dark));
        box-shadow: inset -2px -3px 0 rgba(0, 0, 0, 0.12);
      }

      .fruit-slot.melon .fruit-piece::before {
        content: "";
        position: absolute;
        top: -10px;
        left: 50%;
        width: 16px;
        height: 6px;
        background: #8b8f57;
        border-radius: 999px;
        transform: translateX(-50%);
        border: 2px solid var(--line);
      }

      .fruit-slot.pineapple .fruit-piece {
        width: 36px;
        height: 52px;
        border-radius: 45% 45% 60% 60%;
        background:
          repeating-linear-gradient(
            45deg,
            rgba(255, 255, 255, 0.35) 0 4px,
            transparent 4px 10px
          ),
          repeating-linear-gradient(
            -45deg,
            rgba(255, 255, 255, 0.35) 0 4px,
            transparent 4px 10px
          ),
          radial-gradient(circle at 30% 30%, var(--fruit-light), var(--fruit-dark));
        border: 3px solid var(--line);
      }

      .fruit-slot.pineapple .fruit-piece.leaf::after {
        width: 20px;
        height: 20px;
        top: -14px;
        left: 50%;
        right: auto;
        border-radius: 0;
        border: 2px solid var(--line);
        clip-path: polygon(
          50% 0%,
          65% 32%,
          100% 40%,
          70% 55%,
          78% 90%,
          50% 68%,
          22% 90%,
          30% 55%,
          0% 40%,
          35% 32%
        );
        transform: translateX(-50%) rotate(-10deg);
      }

      .bottom-bar {
        margin-top: 16px;
      }

      .done-button {
        border: 4px solid var(--line);
        background: var(--accent-3);
        border-radius: 18px;
        padding: 14px 18px;
        font-size: 18px;
        font-weight: 700;
        box-shadow: 0 6px 0 var(--line);
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      .done-button:hover {
        transform: translateY(-2px);
      }

      .done-button:active {
        transform: translateY(2px);
        box-shadow: 0 3px 0 var(--line);
      }

      .done-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: 0 4px 0 var(--line);
      }

      .ghost-button {
        height: 44px;
      }

      .counting-panel {
        background: var(--panel);
        border: 4px solid var(--line);
        border-radius: 20px;
        padding: 14px 16px;
        box-shadow: 0 6px 0 var(--line);
      }

      .counting-grid {
        display: grid;
        grid-template-columns: repeat(6, minmax(0, 1fr));
        gap: 10px;
      }

      .counting-row {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        padding: 10px 8px;
        border-radius: 12px;
        background: #fff8f1;
        border: 2px solid var(--line);
      }

      .counting-fruit {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        font-weight: 700;
      }

      .counting-note {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        font-weight: 700;
      }

      .counting-count {
        font-weight: 700;
        letter-spacing: 1px;
      }

      .counting-fruit .plate-fruit {
        width: 22px;
        height: 22px;
      }

      .counting-fruit .plate-fruit.pineapple {
        width: 22px;
        height: 22px;
      }

      .counting-count.mark {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
      }

      .count-mark {
        width: 18px;
        height: 3px;
        background: var(--line);
        transform: rotate(-55deg);
        border-radius: 999px;
      }

      @media (max-width: 1100px) {
        .main-grid {
          grid-template-columns: 1fr 160px;
        }
      }

      @media (max-width: 900px) {
        .main-grid {
          grid-template-columns: 1fr;
        }

        .side-panel {
          min-height: auto;
        }

        .customer-panel {
          grid-template-columns: 1fr;
        }

        .fruit-bins {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      @media (max-width: 700px) {
        .app {
          padding: 16px;
        }

        .top-bar {
          flex-direction: column;
        }

        .bottom-bar {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="home-screen" id="home-screen" aria-hidden="true">
        <div class="home-title">Fruit Order</div>
        <div class="home-content">
          <div class="home-panel">
            <div class="home-customers">
              <div class="home-customer" data-order="orange">
                <div class="home-bubble">
                  <div class="home-bubble-items"></div>
                </div>
                <img class="home-customer-image" src="assets/characters/boy.png" alt="손님" />
              </div>
              <div class="home-customer" data-order="apple,apple">
                <div class="home-bubble">
                  <div class="home-bubble-items"></div>
                </div>
                <img class="home-customer-image" src="assets/characters/girl.png" alt="손님" />
              </div>
              <div class="home-customer" data-order="blueberry,orange">
                <div class="home-bubble">
                  <div class="home-bubble-items"></div>
                </div>
                <img class="home-customer-image" src="assets/characters/grandfa.png" alt="손님" />
              </div>
              <div class="home-customer" data-order="melon,peach">
                <div class="home-bubble">
                  <div class="home-bubble-items"></div>
                </div>
                <img class="home-customer-image" src="assets/characters/grandma.png" alt="손님" />
              </div>
              <div class="home-customer" data-order="pineapple,apple">
                <div class="home-bubble">
                  <div class="home-bubble-items"></div>
                </div>
                <img class="home-customer-image" src="assets/characters/man.png" alt="손님" />
              </div>
              <div class="home-customer" data-order="orange,blueberry,blueberry">
                <div class="home-bubble">
                  <div class="home-bubble-items"></div>
                </div>
                <img class="home-customer-image" src="assets/characters/woman.png" alt="손님" />
              </div>
            </div>
          </div>
          <div class="home-stages">
            <button class="stage-button" type="button" data-stage-button="1">Stage 1</button>
            <button class="stage-button" type="button" data-stage-button="2">Stage 2</button>
            <button class="stage-button" type="button" data-stage-button="3">Stage 3</button>
            <button class="stage-button" type="button" data-stage-button="4">Stage 4</button>
          </div>
        </div>
      </div>

      <div class="game-screen" id="game-screen">
        <div class="top-bar">
          <div class="top-left">
            <button class="pill-button home" type="button" aria-label="홈" id="home-button">
              <span class="home-icon" aria-hidden="true"></span>
            </button>
            <button class="pill-button upgrade" type="button" id="stage-label">Stage 1</button>
          </div>
          <div class="top-right">
            <div class="resource">
              <span>주문</span>
              <strong>12</strong>
            </div>
            <div class="resource">
              <span>코인</span>
              <strong>3,784</strong>
            </div>
            <div class="resource">
              <span>보석</span>
              <strong>24</strong>
            </div>
          </div>
        </div>

        <div class="main-grid">
          <section class="workbench">
            <div class="clock-timer">
              <div class="clock-face">
                <div class="clock-fill" id="clock-fill"></div>
                <span class="clock-top-button"></span>
                <span class="clock-handle"></span>
                <div class="clock-center"></div>
              </div>
              <button class="clock-toggle" id="clock-toggle" data-state="paused" aria-label="재생">
                <span class="icon-play"></span>
                <span class="icon-pause"></span>
              </button>
            </div>
            <div class="stage4-note" id="stage4-note">
              멜론이 다 떨어졌어요! 똑같은 길이의 과일을 조합해봐요!
            </div>
            <div class="customer-panel">
              <div class="customer">
                <img
                  class="customer-image"
                  id="customer-image"
                  src="assets/characters/girl.png"
                  alt="손님 캐릭터"
                />
              </div>
              <div class="order-card">
                <div class="order-items" id="order-items"></div>
              </div>
            </div>

            <div class="fruit-bins" id="fruit-bins"></div>
          </section>

          <aside class="side-panel right">
            <div class="topping-grid" id="topping-grid"></div>
          </aside>
        </div>

        <div class="bottom-bar" aria-hidden="true"></div>
        <div class="counting-panel">
          <div class="counting-grid">
            <div class="counting-row">
              <div class="counting-fruit">
                <span class="plate-fruit orange leaf"></span>
                <span>귤</span>
              </div>
              <div class="counting-note">
                <span class="note">
                  <span class="head"></span>
                  <span class="stem"></span>
                </span>
                <span>4분음표</span>
              </div>
              <div class="counting-count">V</div>
            </div>
            <div class="counting-row">
              <div class="counting-fruit">
                <span class="plate-fruit apple leaf"></span>
                <span>사과</span>
              </div>
              <div class="counting-note">
                <span class="note">
                  <span class="head"></span>
                  <span class="stem"></span>
                  <span class="flag flag1"></span>
                </span>
                <span>8분음표</span>
              </div>
              <div class="counting-count mark">
                <span class="count-mark"></span>
              </div>
            </div>
            <div class="counting-row">
              <div class="counting-fruit">
                <span class="plate-fruit blueberry"></span>
                <span>블루베리</span>
              </div>
              <div class="counting-note">
                <span class="note">
                  <span class="head"></span>
                  <span class="stem"></span>
                  <span class="flag flag1"></span>
                  <span class="flag flag2"></span>
                </span>
                <span>16분음표</span>
              </div>
              <div class="counting-count mark">
                <span class="count-mark"></span>
              </div>
            </div>
            <div class="counting-row">
              <div class="counting-fruit">
                <span class="plate-fruit melon"></span>
                <span>멜론</span>
              </div>
              <div class="counting-note">
                <span class="note hollow">
                  <span class="head"></span>
                  <span class="stem"></span>
                </span>
                <span>2분음표</span>
              </div>
              <div class="counting-count">VV</div>
            </div>
            <div class="counting-row">
              <div class="counting-fruit">
                <span class="plate-fruit peach"></span>
                <span>복숭아</span>
              </div>
              <div class="counting-note">
                <span class="note hollow">
                  <span class="head"></span>
                  <span class="stem"></span>
                  <span class="dot"></span>
                </span>
                <span>점2분음표</span>
              </div>
              <div class="counting-count">VVV</div>
            </div>
            <div class="counting-row">
              <div class="counting-fruit">
                <span class="plate-fruit pineapple"></span>
                <span>파인애플</span>
              </div>
              <div class="counting-note">
                <span class="note whole hollow">
                  <span class="head"></span>
                </span>
                <span>온음표</span>
              </div>
              <div class="counting-count">VVVV</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="result-overlay" id="result-overlay" aria-hidden="true">
      <div class="result-card">
        <p id="result-text">서빙 성공!</p>
        <button type="button" id="result-button">다음 주문</button>
      </div>
    </div>

    <script>
      const fruits = [
        { id: "orange", emoji: "🍊", name: "귤", note: "♩", desc: "4분", length: 4 },
        { id: "apple", emoji: "🍎", name: "사과", note: "♪", desc: "8분", length: 2 },
        { id: "blueberry", emoji: "🫐", name: "블루베리", note: "𝅘𝅥𝅯", desc: "16분", length: 1 },
        { id: "melon", emoji: "🍈", name: "멜론", note: "𝅗𝅥", desc: "2분", length: 8 },
        { id: "peach", emoji: "🍑", name: "복숭아", note: "점", desc: "점2분", length: 12 },
        { id: "pineapple", emoji: "🍍", name: "파인애플", note: "𝅝", desc: "온음표", length: 16 }
      ];

      let currentOrder = { stage: 1, items: [] };
      let currentStage = 0;

      const plate = [];
      const stageDuration = 60;
      let timeLeft = stageDuration;
      let timerInterval = null;
      let isPaused = true;
      let isStarted = false;

      const fruitBins = document.getElementById("fruit-bins");
      const orderItems = document.getElementById("order-items");
      const customerImage = document.getElementById("customer-image");
      const toppingGrid = document.getElementById("topping-grid");
      const clockFill = document.getElementById("clock-fill");
      const clockHandle = document.querySelector(".clock-handle");
      const clockToggle = document.getElementById("clock-toggle");
      const resultOverlay = document.getElementById("result-overlay");
      const resultText = document.getElementById("result-text");
      const resultButton = document.getElementById("result-button");
      const homeScreen = document.getElementById("home-screen");
      const gameScreen = document.getElementById("game-screen");
      const homeButton = document.getElementById("home-button");
      const stageLabel = document.getElementById("stage-label");
      const stageButtons = document.querySelectorAll("[data-stage-button]");
      const homeCustomers = document.querySelectorAll(".home-customer");
      const stage4Note = document.getElementById("stage4-note");

      function renderOrder() {
        orderItems.innerHTML = "";
        currentOrder.items.forEach((item) => {
          const fruit = fruits.find((candidate) => candidate.id === item.id);
          const wrapper = document.createElement("div");
          wrapper.className = "order-item";
          const chip = createFruitChip(item.id);
          if (chip) {
            wrapper.appendChild(chip);
          } else {
            const fallback = document.createElement("span");
            fallback.textContent = fruit ? fruit.emoji : "";
            wrapper.appendChild(fallback);
          }
          const qty = document.createElement("span");
          qty.className = "order-qty";
          qty.textContent = `x${item.qty}`;
          wrapper.appendChild(qty);
          orderItems.appendChild(wrapper);
        });
        updateStageNotice();
      }

      function updateStageNotice() {
        if (!stage4Note) return;
        const isStage4 = currentStage === 4;
        const target = currentOrder.items && currentOrder.items[0];
        if (isStage4 && target) {
          const fruit = fruits.find((item) => item.id === target.id);
          const name = fruit ? fruit.name : "과일";
          const particle = getSubjectParticle(name);
          stage4Note.innerHTML = `${name}${particle} 다 떨어졌어요!<br>똑같은 음표 길이의 과일을 조합해주세요!`;
          stage4Note.classList.add("is-visible");
        } else {
          stage4Note.classList.remove("is-visible");
        }
      }

      function getSubjectParticle(word) {
        if (!word) return "이";
        const lastChar = word[word.length - 1];
        const code = lastChar.charCodeAt(0);
        if (code < 0xac00 || code > 0xd7a3) return "이";
        return (code - 0xac00) % 28 === 0 ? "가" : "이";
      }

      function renderHomeBubbles() {
        homeCustomers.forEach((card) => {
          const list = card.dataset.order ? card.dataset.order.split(",") : [];
          const bubble = card.querySelector(".home-bubble-items");
          if (!bubble) return;
          bubble.innerHTML = "";
          list.forEach((id) => {
            const chip = createFruitChip(id);
            if (!chip) return;
            chip.classList.add("home-fruit-chip");
            bubble.appendChild(chip);
          });
        });
      }

      function updateStageLabel() {
        if (!stageLabel) return;
        stageLabel.textContent = `Stage ${currentStage}`;
      }

      function showHome() {
        if (homeScreen) {
          homeScreen.classList.add("is-visible");
          homeScreen.setAttribute("aria-hidden", "false");
        }
        if (gameScreen) {
          gameScreen.classList.add("is-hidden");
          gameScreen.setAttribute("aria-hidden", "true");
        }
      }

      function showGame() {
        if (homeScreen) {
          homeScreen.classList.remove("is-visible");
          homeScreen.setAttribute("aria-hidden", "true");
        }
        if (gameScreen) {
          gameScreen.classList.remove("is-hidden");
          gameScreen.setAttribute("aria-hidden", "false");
        }
      }

      const customers = [
        "assets/characters/boy.png",
        "assets/characters/girl.png",
        "assets/characters/grandfa.png",
        "assets/characters/grandma.png",
        "assets/characters/man.png",
        "assets/characters/woman.png"
      ];

      function randomItem(list) {
        return list[Math.floor(Math.random() * list.length)];
      }

      function pickCustomer() {
        if (!customerImage) return;
        customerImage.src = randomItem(customers);
      }

      function buildItemsFromCounts(counts) {
        return Object.entries(counts).map(([id, qty]) => ({ id, qty }));
      }

      function generateStage1() {
        const fruit = randomItem(fruits);
        return { stage: 1, items: [{ id: fruit.id, qty: 1 }] };
      }

      function generateStage2() {
        const fruit = randomItem(fruits);
        const qty = 2 + Math.floor(Math.random() * 3);
        return { stage: 2, items: [{ id: fruit.id, qty }] };
      }

      function generateStage3() {
        const count = 2 + Math.floor(Math.random() * 2);
        const shuffled = [...fruits].sort(() => Math.random() - 0.5).slice(0, count);
        const items = shuffled.map((fruit) => ({
          id: fruit.id,
          qty: 1 + Math.floor(Math.random() * 2)
        }));
        return { stage: 3, items };
      }

      function findReplacement(targetId) {
        const target = fruits.find((fruit) => fruit.id === targetId);
        if (!target) return null;
        const others = fruits.filter((fruit) => fruit.id !== targetId);
        const targetLength = target.length;

        for (let attempt = 0; attempt < 200; attempt += 1) {
          const counts = {};
          let total = 0;
          let totalItems = 0;
          others.forEach((fruit) => {
            const qty = Math.floor(Math.random() * 5);
            if (qty > 0) {
              counts[fruit.id] = qty;
              total += fruit.length * qty;
              totalItems += qty;
            }
          });
          if (totalItems >= 2 && total === targetLength) {
            return buildItemsFromCounts(counts);
          }
        }

        const fallback = {
          melon: [{ id: "orange", qty: 2 }],
          peach: [{ id: "melon", qty: 1 }, { id: "orange", qty: 1 }],
          pineapple: [{ id: "melon", qty: 2 }],
          orange: [{ id: "apple", qty: 2 }],
          apple: [{ id: "blueberry", qty: 2 }]
        };
        return fallback[targetId] || null;
      }

      function generateStage4() {
        const eligible = fruits.filter((fruit) => fruit.id !== "blueberry");
        const target = randomItem(eligible);
        const replacement = findReplacement(target.id);
        if (!replacement) {
          return generateStage3();
        }
        return { stage: 4, items: [{ id: target.id, qty: 1 }] };
      }

      function nextOrder() {
        if (currentStage === 1) currentOrder = generateStage1();
        if (currentStage === 2) currentOrder = generateStage2();
        if (currentStage === 3) currentOrder = generateStage3();
        if (currentStage === 4) currentOrder = generateStage4();
        pickCustomer();
        renderOrder();
      }

      function startStage(stage) {
        currentStage = stage;
        nextOrder();
        startStageTimer();
        updateStageLabel();
      }

      function advanceStage() {
        plate.splice(0, plate.length);
        renderPlateItems();
        renderNoteStickers();
        updateServeButton();
        currentStage = currentStage % 4 + 1;
        nextOrder();
        startStageTimer();
        updateStageLabel();
      }

      function updateTimerUI() {
        const ratio = Math.max(timeLeft, 0) / stageDuration;
        if (clockFill) {
          const degrees = Math.max(0, ratio) * 360;
          clockFill.style.background = `conic-gradient(#4aa6d6 ${degrees}deg, transparent 0deg)`;
        }
        if (clockHandle) {
          const angle = Math.max(0, ratio) * 360;
          clockHandle.style.transform = `translate(-50%, -100%) rotate(${angle}deg)`;
        }
      }

      function updateClockToggle() {
        if (!clockToggle) return;
        const state = isPaused ? "paused" : "playing";
        clockToggle.dataset.state = state;
        clockToggle.setAttribute("aria-label", isPaused ? "재생" : "일시정지");
      }

      function startStageTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timeLeft = stageDuration;
        updateTimerUI();
        isPaused = true;
        updateClockToggle();
        timerInterval = setInterval(() => {
          if (isPaused) return;
          timeLeft -= 1;
          if (timeLeft <= 0) {
            timeLeft = 0;
            updateTimerUI();
            showStageComplete();
            return;
          }
          updateTimerUI();
        }, 1000);
      }

      function renderToppings() {
        toppingGrid.innerHTML = "";
        const plateWrap = document.createElement("div");
        plateWrap.className = "plate-drop";
        plateWrap.id = "plate-drop";
        const noteStrip = document.createElement("div");
        noteStrip.className = "note-stickers";
        noteStrip.id = "note-stickers";
        const plateItems = document.createElement("div");
        plateItems.className = "plate-items";
        plateItems.id = "plate-items";
        const plateBase = document.createElement("div");
        plateBase.className = "plate-illustration";
        const serveButton = document.createElement("button");
        serveButton.className = "serve-button";
        serveButton.type = "button";
        serveButton.id = "serve-button";
        serveButton.textContent = "서빙하기";
        const clearButton = document.createElement("button");
        clearButton.className = "clear-button";
        clearButton.type = "button";
        clearButton.id = "clear-button";
        clearButton.textContent = "접시 비우기";
        plateWrap.appendChild(plateItems);
        plateWrap.appendChild(plateBase);
        plateWrap.appendChild(serveButton);
        plateWrap.appendChild(clearButton);
        if (toppingGrid.parentElement) {
          toppingGrid.parentElement.appendChild(noteStrip);
        }
        toppingGrid.appendChild(plateWrap);

        plateWrap.addEventListener("dragover", (event) => {
          event.preventDefault();
        });
        plateWrap.addEventListener("drop", (event) => {
          event.preventDefault();
          if (!isStarted || isPaused) {
            showStartPrompt();
            return;
          }
          const fruitId = event.dataTransfer.getData("text/plain");
          if (fruitId) {
            plate.push(fruitId);
            renderPlateItems();
            renderNoteStickers();
            updateServeButton();
          }
        });
      }

      function createFruitChip(fruitId) {
        const fruit = fruits.find((item) => item.id === fruitId);
        if (!fruit) return null;
        const chip = document.createElement("span");
        const leafClass =
          fruitId === "blueberry" || fruitId === "melon" ? "" : "leaf";
          const pearClass = fruitId === "melon" ? "melon" : "";
        const peachClass = fruitId === "peach" ? "peach" : "";
        const pineappleClass = fruitId === "pineapple" ? "pineapple" : "";
        const appleClass = fruitId === "apple" ? "apple" : "";
        chip.className = `plate-fruit ${leafClass} ${pearClass} ${peachClass} ${pineappleClass} ${appleClass} ${fruitId}`.trim();
        if (fruitId === "peach") {
          const line = document.createElement("span");
          line.className = "peach-line";
          chip.appendChild(line);
        }
        const style = {
          orange: { light: "#ffb259", dark: "#f47c2a", leaf: "#73c06b" },
          apple: { light: "#ff6f6f", dark: "#c83232", leaf: "#6abf69" },
          blueberry: { light: "#8ea0ff", dark: "#3d4fd1", leaf: "#6abf69" },
          melon: { light: "#b9d56e", dark: "#9cbc4f", leaf: "#5bbf6b" },
          peach: { light: "#ffb5a6", dark: "#e6766a", leaf: "#7ac06b" },
          pineapple: { light: "#ffd365", dark: "#f2a93f", leaf: "#5bbf6b" }
        };
        const palette = style[fruitId];
        if (palette) {
          chip.style.setProperty("--fruit-light", palette.light);
          chip.style.setProperty("--fruit-dark", palette.dark);
          chip.style.setProperty("--leaf", palette.leaf);
        }
        return chip;
      }

      function renderPlateItems() {
        const plateItems = document.getElementById("plate-items");
        if (!plateItems) return;
        plateItems.innerHTML = "";
        plate.forEach((id, index) => {
          const chip = createFruitChip(id);
          if (!chip) return;
          const wrapper = document.createElement("div");
          wrapper.className = "plate-chip";
          const remove = document.createElement("button");
          remove.className = "plate-remove";
          remove.type = "button";
          remove.textContent = "x";
          remove.addEventListener("click", () => {
            plate.splice(index, 1);
            renderPlateItems();
            renderNoteStickers();
            updateServeButton();
          });
          wrapper.appendChild(chip);
          wrapper.appendChild(remove);
          plateItems.appendChild(wrapper);
        });
      }

      function buildNoteIcon(type) {
        const noteIcon = document.createElement("span");
        noteIcon.className = `note ${type}`;
        const head = document.createElement("span");
        head.className = "head";
        noteIcon.appendChild(head);
        if (type !== "whole") {
          const stem = document.createElement("span");
          stem.className = "stem";
          noteIcon.appendChild(stem);
        }
        if (type === "eighth" || type === "sixteenth") {
          const flag1 = document.createElement("span");
          flag1.className = "flag flag1";
          noteIcon.appendChild(flag1);
        }
        if (type === "sixteenth") {
          const flag2 = document.createElement("span");
          flag2.className = "flag flag2";
          noteIcon.appendChild(flag2);
        }
        if (type === "half" || type === "whole" || type === "dotted-half") {
          noteIcon.classList.add("hollow");
        }
        if (type === "whole") {
          noteIcon.classList.add("whole");
        }
        if (type === "dotted-half") {
          const dot = document.createElement("span");
          dot.className = "dot";
          noteIcon.appendChild(dot);
        }
        return noteIcon;
      }

      function renderNoteStickers() {
        const noteStrip = document.getElementById("note-stickers");
        if (!noteStrip) return;
        noteStrip.innerHTML = "";
        const noteLabels = {
          orange: { type: "quarter", label: "4분음표" },
          apple: { type: "eighth", label: "8분음표" },
          blueberry: { type: "sixteenth", label: "16분음표" },
          melon: { type: "half", label: "2분음표" },
          peach: { type: "dotted-half", label: "점2분음표" },
          pineapple: { type: "whole", label: "온음표" }
        };
        plate.forEach((id) => {
          const note = noteLabels[id];
          if (!note) return;
          const chip = document.createElement("div");
          chip.className = "note-chip";
          chip.appendChild(buildNoteIcon(note.type));
          const label = document.createElement("span");
          label.textContent = note.label;
          chip.appendChild(label);
          noteStrip.appendChild(chip);
        });
      }

      function renderFruitBins() {
        fruitBins.innerHTML = "";
        const fruitStyles = {
          orange: { light: "#ffb259", dark: "#f47c2a", leaf: "#73c06b" },
          apple: { light: "#ff6f6f", dark: "#c83232", leaf: "#6abf69" },
          blueberry: { light: "#8ea0ff", dark: "#3d4fd1", leaf: "#6abf69" },
          melon: { light: "#b9d56e", dark: "#9cbc4f", leaf: "#5bbf6b" },
          peach: { light: "#ffb5a6", dark: "#e6766a", leaf: "#7ac06b" },
          pineapple: { light: "#ffd365", dark: "#f2a93f", leaf: "#5bbf6b" }
        };
        const noteLabels = {
          orange: { type: "quarter", label: "4분음표" },
          apple: { type: "eighth", label: "8분음표" },
          blueberry: { type: "sixteenth", label: "16분음표" },
          melon: { type: "half", label: "2분음표" },
          peach: { type: "dotted-half", label: "점2분음표" },
          pineapple: { type: "whole", label: "온음표" }
        };
        fruits.forEach((fruit) => {
          const style = fruitStyles[fruit.id] || {
            light: "#ffd4b8",
            dark: "#f2a07b",
            leaf: "#6abf69"
          };
          const note = noteLabels[fruit.id] || { type: "quarter", label: "" };
          const button = document.createElement("button");
          button.className = `fruit-slot ${fruit.id}`.trim();
          button.type = "button";
          button.draggable = true;
          button.style.setProperty("--fruit-light", style.light);
          button.style.setProperty("--fruit-dark", style.dark);
          button.style.setProperty("--leaf", style.leaf);
          button.addEventListener("dragstart", (event) => {
            if (!isStarted || isPaused) {
              event.preventDefault();
              showStartPrompt();
              return;
            }
            event.dataTransfer.setData("text/plain", fruit.id);
            const dragChip = createFruitChip(fruit.id);
            if (dragChip) {
              dragChip.style.position = "absolute";
              dragChip.style.top = "-9999px";
              dragChip.style.left = "-9999px";
              document.body.appendChild(dragChip);
              event.dataTransfer.setDragImage(dragChip, 12, 12);
              requestAnimationFrame(() => dragChip.remove());
            }
          });
          const cluster = document.createElement("div");
          cluster.className = "fruit-cluster";
          const totalPieces =
            fruit.id === "blueberry" ? 20 : fruit.id === "melon" ? 5 : 7;
          for (let i = 1; i <= totalPieces; i += 1) {
            const piece = document.createElement("span");
            const leafClass =
              fruit.id === "blueberry" || fruit.id === "melon"
                ? ""
                : i % 2 === 0
                  ? "leaf"
                  : "";
            piece.className = `fruit-piece p${i} ${leafClass}`.trim();
            if (fruit.id === "peach") {
              const line = document.createElement("span");
              line.className = "peach-line";
              piece.appendChild(line);
            }
            cluster.appendChild(piece);
          }
          const basket = document.createElement("div");
          basket.className = "basket";
          const fruitLabel = document.createElement("div");
          fruitLabel.className = "fruit-label";
          fruitLabel.textContent = fruit.name;
          const plankTop = document.createElement("div");
          plankTop.className = "crate-plank top";
          const plankMid = document.createElement("div");
          plankMid.className = "crate-plank mid";
          const plankBottom = document.createElement("div");
          plankBottom.className = "crate-plank bottom";
          const sticker = document.createElement("div");
          sticker.className = "crate-sticker";
          const noteIcon = document.createElement("span");
          noteIcon.className = `note ${note.type}`;
          const head = document.createElement("span");
          head.className = "head";
          noteIcon.appendChild(head);
          if (note.type !== "whole") {
            const stem = document.createElement("span");
            stem.className = "stem";
            noteIcon.appendChild(stem);
          }
          if (note.type === "eighth" || note.type === "sixteenth") {
            const flag1 = document.createElement("span");
            flag1.className = "flag flag1";
            noteIcon.appendChild(flag1);
          }
          if (note.type === "sixteenth") {
            const flag2 = document.createElement("span");
            flag2.className = "flag flag2";
            noteIcon.appendChild(flag2);
          }
          if (note.type === "half" || note.type === "whole" || note.type === "dotted-half") {
            noteIcon.classList.add("hollow");
          }
          if (note.type === "whole") {
            noteIcon.classList.add("whole");
          }
          if (note.type === "dotted-half") {
            const dot = document.createElement("span");
            dot.className = "dot";
            noteIcon.appendChild(dot);
          }
          const noteLabel = document.createElement("div");
          noteLabel.textContent = note.label;
          sticker.appendChild(noteIcon);
          sticker.appendChild(noteLabel);
          basket.appendChild(plankTop);
          basket.appendChild(plankMid);
          basket.appendChild(plankBottom);
          basket.appendChild(sticker);
          button.appendChild(fruitLabel);
          button.appendChild(cluster);
          button.appendChild(basket);
          fruitBins.appendChild(button);
        });
      }

      function updateServeButton() {
        const serveButton = document.getElementById("serve-button");
        if (!serveButton) return;
        serveButton.disabled = plate.length === 0;
      }

      function plateCounts() {
        return plate.reduce((acc, id) => {
          acc[id] = (acc[id] || 0) + 1;
          return acc;
        }, {});
      }

      function validateOrder() {
        const counts = plateCounts();
        if (plate.length === 0) return false;

        if (currentStage === 1) {
          const target = currentOrder.items[0];
          return (
            plate.length === 1 &&
            target &&
            plate[0] === target.id &&
            target.qty === 1
          );
        }

        if (currentStage === 2) {
          const target = currentOrder.items[0];
          if (!target) return false;
          const keys = Object.keys(counts);
          return keys.length === 1 && counts[target.id] === target.qty;
        }

        if (currentStage === 3) {
          const expected = currentOrder.items.reduce((acc, item) => {
            acc[item.id] = item.qty;
            return acc;
          }, {});
          const keys = Object.keys(counts);
          if (keys.length !== Object.keys(expected).length) return false;
          return keys.every((id) => counts[id] === expected[id]);
        }

        if (currentStage === 4) {
          const target = currentOrder.items[0];
          if (!target) return false;
          const targetFruit = fruits.find((fruit) => fruit.id === target.id);
          if (!targetFruit) return false;
          const total = plate.reduce((sum, id) => {
            const fruit = fruits.find((item) => item.id === id);
            return sum + (fruit ? fruit.length : 0);
          }, 0);
          const hasTarget = plate.includes(target.id);
          return total === targetFruit.length && !hasTarget;
        }
        return false;
      }

      function showResult(success) {
        if (!resultOverlay || !resultText || !resultButton) return;
        resultText.textContent = success ? "서빙 성공!" : "다시 해볼까요?";
        resultButton.textContent = success ? "다음 주문" : "다시 하기";
        resultOverlay.classList.add("active");
        resultOverlay.setAttribute("aria-hidden", "false");
        resultOverlay.querySelector(".result-card")?.classList.remove("stage");
      }

      function showStageComplete() {
        if (!resultOverlay || !resultText || !resultButton) return;
        resultText.textContent = `Stage ${currentStage} 완료!`;
        resultButton.textContent = "다음 Stage";
        resultOverlay.classList.add("active");
        resultOverlay.setAttribute("aria-hidden", "false");
        resultOverlay.querySelector(".result-card")?.classList.add("stage");
      }

      function showStartPrompt() {
        if (!resultOverlay || !resultText || !resultButton) return;
        resultText.textContent = "재생 버튼을 누른 후 시작해주세요!";
        resultButton.textContent = "확인";
        resultOverlay.classList.add("active");
        resultOverlay.setAttribute("aria-hidden", "false");
        resultOverlay.querySelector(".result-card")?.classList.remove("stage");
      }

      function hideResult() {
        if (!resultOverlay) return;
        resultOverlay.classList.remove("active");
        resultOverlay.setAttribute("aria-hidden", "true");
      }

      renderToppings();
      renderFruitBins();
      renderNoteStickers();
      updateTimerUI();
      updateClockToggle();

      if (clockToggle) {
        clockToggle.addEventListener("click", () => {
          if (!isStarted) {
            isStarted = true;
          }
          isPaused = !isPaused;
          updateClockToggle();
        });
      }

      if (homeButton) {
        homeButton.addEventListener("click", () => {
          showHome();
        });
      }

      stageButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const stage = Number(button.dataset.stageButton || 1);
          plate.splice(0, plate.length);
          renderPlateItems();
          renderNoteStickers();
          updateServeButton();
          startStage(stage);
          showGame();
        });
      });

      renderHomeBubbles();
      updateServeButton();
      isStarted = false;
      startStage(1);
      showHome();

      document.addEventListener("click", (event) => {
        if (event.target && event.target.id === "serve-button") {
          const success = validateOrder();
          showResult(success);
        }
        if (event.target && event.target.id === "clear-button") {
          plate.splice(0, plate.length);
          renderPlateItems();
          renderNoteStickers();
          updateServeButton();
        }
      });

      if (resultButton) {
        resultButton.addEventListener("click", () => {
          const wasSuccess = resultText && resultText.textContent.includes("성공");
          const wasStage = resultText && resultText.textContent.includes("Stage");
          hideResult();
          if (wasStage) {
            advanceStage();
            return;
          }
          if (wasSuccess) {
            plate.splice(0, plate.length);
            renderPlateItems();
            renderNoteStickers();
            updateServeButton();
            nextOrder();
          }
        });
      }
    </script>
  </body>
</html>
